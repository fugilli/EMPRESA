<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <title>Conta Corrente – Gestão de Empresa</title>
  <script>(function(){var t=localStorage.getItem('theme');if(t==='dark'||(!t&&window.matchMedia('(prefers-color-scheme: dark)').matches))document.documentElement.classList.add('dark');})()</script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background:#f0f2f5; font-family:system-ui,sans-serif; margin:0; }
    .topbar { background:#1a1a2e; color:#fff; padding:0 24px; display:flex; align-items:center; justify-content:space-between; height:52px; }
    .brand { font-weight:600; font-size:1rem; }
    .topbar-right { display:flex; align-items:center; gap:12px; }
    .badge-cal { background:#4f8ef7; color:#fff; border-radius:20px; padding:3px 12px; font-size:.8rem; }
    .btn-topbar { color:#fff; font-size:.78rem; border:1px solid rgba(255,255,255,.4); border-radius:5px; padding:4px 10px; text-decoration:none; cursor:pointer; background:none; }
    .btn-topbar:hover { background:rgba(255,255,255,.1); color:#fff; }
    .tabs { background:#fff; border-bottom:2px solid #e5e7eb; display:flex; padding:0 24px; }
    .tab { padding:12px 20px; font-size:.9rem; font-weight:500; color:#666; text-decoration:none; border-bottom:3px solid transparent; margin-bottom:-2px; transition:color .15s; }
    .tab:hover { color:#1a1a2e; }
    .tab.active { color:#1a1a2e; border-bottom-color:#4f8ef7; }

    .filter-bar { background:#fff; border-bottom:1px solid #eee; padding:10px 24px; display:flex; align-items:center; gap:12px; flex-wrap:wrap; }
    .filter-label { font-size:.78rem; font-weight:600; color:#888; }
    .btn-view { border:1px solid #d1d5db; border-radius:6px; padding:4px 14px; font-size:.82rem; cursor:pointer; background:#fff; color:#555; }
    .btn-view.active { background:#1a1a2e; color:#fff; border-color:#1a1a2e; }
    .btn-csv { background:#e8f5e9; color:#2e7d32; border:none; border-radius:6px; padding:3px 10px; font-size:.75rem; font-weight:600; cursor:pointer; }
    .btn-csv:hover { background:#c8e6c9; }
    .btn-cfg { background:#e3f2fd; color:#1565c0; border:none; border-radius:6px; padding:3px 10px; font-size:.75rem; font-weight:600; cursor:pointer; }
    .btn-cfg:hover { background:#bbdefb; }

    .main { padding:20px 24px; }
    .layout { display:grid; grid-template-columns:1fr 340px; gap:18px; align-items:start; }
    @media(max-width:1100px){ .layout { grid-template-columns:1fr; } }

    .card { border:none; border-radius:10px; box-shadow:0 2px 8px rgba(0,0,0,.07); background:#fff; margin-bottom:18px; overflow:hidden; }
    .card-head { padding:12px 18px; font-weight:700; font-size:.92rem; color:#1a1a2e; border-bottom:1px solid #eee; display:flex; align-items:center; justify-content:space-between; }

    .pl-section { padding:14px 18px; }
    .pl-row { display:flex; justify-content:space-between; padding:4px 0; font-size:.88rem; }
    .pl-row.cat { padding-left:20px; color:#666; font-size:.84rem; }
    .pl-row.subtotal { font-weight:600; border-top:1px solid #eee; padding-top:8px; margin-top:4px; }
    .pl-row.section-title { font-weight:700; color:#1a1a2e; margin-top:10px; border-bottom:2px solid #eee; padding-bottom:6px; }
    .pl-row.resultado-pos { font-weight:700; font-size:1rem; color:#1a5c34; background:#e8f5e9; border-radius:6px; padding:8px 12px; margin:6px 0; }
    .pl-row.resultado-neg { font-weight:700; font-size:1rem; color:#b71c1c; background:#ffebee; border-radius:6px; padding:8px 12px; margin:6px 0; }
    .pl-sep { border:none; border-top:2px solid #1a1a2e; margin:10px 0; opacity:.15; }

    .irc-card { background:#f8faff; border:1px solid #e3ecff; }
    .irc-row { display:flex; justify-content:space-between; padding:5px 0; font-size:.87rem; }
    .irc-row.total { font-weight:700; border-top:2px solid #1a1a2e; padding-top:10px; margin-top:6px; }
    .irc-ppc { background:#fff3e0; border-radius:6px; padding:10px 14px; margin-top:10px; font-size:.84rem; }
    .irc-ppc-title { font-weight:700; color:#e65100; font-size:.85rem; margin-bottom:6px; }
    .irc-ppc-row { display:flex; justify-content:space-between; padding:3px 0; color:#555; }
    .irc-ta-block { background:#fff8e1; border:1px solid #ffe082; border-radius:6px; padding:10px 14px; margin-top:10px; font-size:.84rem; }
    .irc-ta-title { font-weight:700; color:#f57f17; font-size:.85rem; margin-bottom:6px; }
    .cat-note { font-size:.72rem; color:#e65100; font-weight:400; margin-left:6px; opacity:.85; }
    .cat-ta   { font-size:.72rem; color:#f57f17; font-weight:600; margin-left:6px; }

    table { font-size:.87rem; margin:0; width:100%; }
    th { background:#1a1a2e; color:#fff; font-weight:500; padding:10px !important; white-space:nowrap; }
    td { padding:9px 12px !important; vertical-align:middle !important; border-bottom:1px solid #f0f0f0; }
    tr:last-child td { border-bottom:none; }
    tr:hover td { background:#f8f9ff; }
    .num { text-align:right; font-variant-numeric:tabular-nums; }
    .pos { color:#1a5c34; font-weight:600; }
    .neg { color:#b71c1c; font-weight:600; }
    .empty-state { text-align:center; padding:60px; color:#aaa; }

    /* modal config */
    .modal-backdrop-cfg { display:none; position:fixed; inset:0; background:rgba(0,0,0,.5); z-index:1000; align-items:center; justify-content:center; }
    .modal-backdrop-cfg.show { display:flex; }
    .modal-box { background:#fff; border-radius:12px; padding:24px; width:420px; max-width:95vw; box-shadow:0 8px 40px rgba(0,0,0,.2); }
    .modal-title { font-weight:700; font-size:1rem; margin-bottom:16px; }
    .form-row { margin-bottom:12px; }
    .form-row label { font-size:.82rem; font-weight:600; color:#555; display:block; margin-bottom:4px; }
    .form-row input { width:100%; border:1px solid #ddd; border-radius:6px; padding:6px 10px; font-size:.88rem; outline:none; }
    .form-row input:focus { border-color:#4f8ef7; }
    .modal-actions { display:flex; gap:10px; justify-content:flex-end; margin-top:16px; }
    .btn-save { background:#1a1a2e; color:#fff; border:none; border-radius:6px; padding:7px 18px; font-size:.85rem; cursor:pointer; }
    .btn-cancel { background:#f0f0f0; color:#555; border:none; border-radius:6px; padding:7px 18px; font-size:.85rem; cursor:pointer; }

    /* dark */
    html.dark body { background:#111318; color:#e0e6f0; }
    html.dark .tabs { background:#161921; border-bottom-color:#2a2d3e; }
    html.dark .tab { color:#8b9ab0; }
    html.dark .tab:hover { color:#e0e6f0; }
    html.dark .tab.active { color:#e0e6f0; }
    html.dark .filter-bar { background:#161921; border-bottom-color:#2a2d3e; }
    html.dark .filter-label { color:#8b9ab0; }
    html.dark .btn-view { background:#1e2130; color:#8b9ab0; border-color:#3a3d4e; }
    html.dark .btn-view.active { background:#4f8ef7; color:#fff; border-color:#4f8ef7; }
    html.dark .card { background:#1e2130; box-shadow:0 2px 8px rgba(0,0,0,.4); }
    html.dark .card-head { color:#e0e6f0; border-bottom-color:#2a2d3e; }
    html.dark .pl-row.cat { color:#8b9ab0; }
    html.dark .pl-row.section-title { color:#e0e6f0; border-bottom-color:#2a2d3e; }
    html.dark .pl-row.subtotal { border-top-color:#2a2d3e; }
    html.dark .irc-card { background:#161921; border-color:#2a2d3e; }
    html.dark .irc-row { color:#e0e6f0; }
    html.dark .irc-row.total { border-top-color:#4f8ef7; color:#e0e6f0; }
    html.dark .irc-ppc { background:#252838; }
    html.dark .irc-ppc-title { color:#ffb74d; }
    html.dark .irc-ppc-row { color:#b0bcd4; }
    html.dark .irc-ta-block { background:#2a2010; border-color:#5a4010; }
    html.dark .irc-ta-title { color:#ffca28; }
    html.dark .cat-note { color:#ff8a65; }
    html.dark .cat-ta   { color:#ffca28; }
    html.dark .pl-row.resultado-pos { color:#69f0ae; background:rgba(105,240,174,.1); }
    html.dark .pl-row.resultado-neg { color:#ff6e6e; background:rgba(255,110,110,.1); }
    html.dark .pos { color:#69f0ae; }
    html.dark .neg { color:#ff6e6e; }
    html.dark th { background:#0d0f1a; }
    html.dark td { color:#e0e6f0; border-bottom-color:#252838; }
    html.dark tr:hover td { background:#252838; }
    html.dark .modal-box { background:#1e2130; color:#e0e6f0; }
    html.dark .form-row label { color:#8b9ab0; }
    html.dark .form-row input { background:#161921; color:#e0e6f0; border-color:#3a3d4e; }
    html.dark .btn-cancel { background:#252838; color:#8b9ab0; }
    html.dark .empty-state { color:#5a6478; }
  </style>
</head>
<body>
{% set active_tab = 'conta_corrente' %}
{% include '_nav.html' %}

<div class="filter-bar">
  <span class="filter-label">Vista:</span>
  <button class="btn-view" id="btnMensal"     onclick="setView('mensal')">Mensal</button>
  <button class="btn-view" id="btnTrimestral" onclick="setView('trimestral')">Trimestral</button>
  <button class="btn-view active" id="btnAnual"      onclick="setView('anual')">Anual</button>

  <span class="filter-label" style="margin-left:16px">Ano:</span>
  <select id="anoSel" onchange="render()"></select>

  <div style="margin-left:auto;display:flex;gap:8px">
    <button class="btn-cfg" onclick="openCfg()">⚙ Configuração fiscal</button>
    <button class="btn-csv" onclick="exportarCSV()">⬇ Exportar CSV</button>
  </div>
</div>

<div class="main" id="mainContainer"></div>

<!-- Modal configuração -->
<div class="modal-backdrop-cfg" id="cfgModal" onclick="closeCfgOutside(event)">
  <div class="modal-box">
    <div class="modal-title">⚙ Configuração Fiscal</div>
    <div class="form-row">
      <label>Taxa IVA sobre rendimentos (%)</label>
      <input type="number" id="cfgIvaRend" step="0.5" min="0" max="23">
    </div>
    <div class="form-row">
      <label>Taxa IRC reduzida PME (%)</label>
      <input type="number" id="cfgIrcRed" step="0.5" min="0" max="25">
    </div>
    <div class="form-row">
      <label>Limiar taxa reduzida (€)</label>
      <input type="number" id="cfgIrcLimiar" step="1000" min="0">
    </div>
    <div class="form-row">
      <label>Taxa IRC normal (%)</label>
      <input type="number" id="cfgIrcNorm" step="0.5" min="0" max="30">
    </div>
    <div class="form-row">
      <label>Taxa derrama municipal (%)</label>
      <input type="number" id="cfgDerrama" step="0.1" min="0" max="1.5">
    </div>
    <div class="form-row">
      <label>Caminho service_account.json</label>
      <input type="text" id="cfgSaPath">
    </div>
    <div class="modal-actions">
      <button class="btn-cancel" onclick="closeCfg()">Cancelar</button>
      <button class="btn-save" onclick="saveCfg()">Guardar</button>
    </div>
  </div>
</div>

<script>
const DADOS = {{ contab_json|safe }};
let CFG     = {{ contab_config|tojson }};
let currentView = 'anual';

const MESES = ['Janeiro','Fevereiro','Março','Abril','Maio','Junho',
               'Julho','Agosto','Setembro','Outubro','Novembro','Dezembro'];
const TRIMESTRES = [
  {label:'Q1',meses:[1,2,3]},{label:'Q2',meses:[4,5,6]},
  {label:'Q3',meses:[7,8,9]},{label:'Q4',meses:[10,11,12]},
];

function fmt(v){ return (v||0).toLocaleString('pt-PT',{minimumFractionDigits:2,maximumFractionDigits:2}); }
function eur(v){ return String((v||0).toFixed(2)).replace('.',','); }
function bom(s){ return '\uFEFF'+s; }

function anos(){
  const s=new Set(DADOS.map(d=>d.year));
  s.add(new Date().getFullYear());
  return [...s].sort((a,b)=>b-a);
}
function selectedAno(){ return parseInt(document.getElementById('anoSel').value||new Date().getFullYear()); }
function dadosMes(ano,mes){ return DADOS.find(d=>d.year===ano&&d.month===mes)||null; }

function agregar(rows){
  const z={rendimentos:0,iva_liquidado:0,gastos_despesas:0,gastos_km:0,gastos_total:0,
           iva_deducivel:0,iva_saldo:0,resultado:0,irc_estimado:0,derrama_estimada:0,
           irc_subtotal:0,tributacao_autonoma:0,ta_representacao:0,ta_km:0,
           gastos_representacao:0,irc_total:0,por_categoria:{}};
  for(const r of rows){
    ['rendimentos','iva_liquidado','gastos_despesas','gastos_km','gastos_total',
     'iva_deducivel','resultado','tributacao_autonoma','ta_representacao','ta_km',
     'gastos_representacao'].forEach(k=>{ z[k]+=(r[k]||0); });
    Object.entries(r.por_categoria||{}).forEach(([cat,val])=>{
      z.por_categoria[cat]=(z.por_categoria[cat]||0)+val;
    });
  }
  z.iva_saldo=Math.round((z.iva_liquidado-z.iva_deducivel)*100)/100;
  // recalcular IRC+derrama com totais agregados (taxas podem ter mudado via CFG)
  const irc=calcIRC(z.resultado);
  z.irc_estimado=irc.irc; z.derrama_estimada=irc.derrama; z.irc_subtotal=irc.total;
  z.tributacao_autonoma=Math.round(z.tributacao_autonoma*100)/100;
  z.irc_total=Math.round((z.irc_subtotal+z.tributacao_autonoma)*100)/100;
  return z;
}

function calcIRC(resultado){
  if(resultado<=0) return {irc:0,derrama:0,total:0};
  const limiar=CFG.irc_limiar_reduzida;
  const red=CFG.irc_taxa_reduzida/100;
  const norm=CFG.irc_taxa_normal/100;
  const derramaT=CFG.taxa_derrama/100;
  const baseRed=Math.min(resultado,limiar);
  const baseNorm=Math.max(0,resultado-limiar);
  const irc=Math.round((baseRed*red+baseNorm*norm)*100)/100;
  const derrama=Math.round(resultado*derramaT*100)/100;
  return {irc,derrama,total:Math.round((irc+derrama)*100)/100};
}

const REPRESENTACAO_CATS = new Set(['Alimentação e Bebidas','Alojamento e Hotelaria']);
const IVA_FACTOR_LABEL = {
  'Alimentação e Bebidas':        'IVA não dedutível (art. 21.º CIVA)',
  'Alojamento e Hotelaria':       'IVA não dedutível (art. 21.º CIVA)',
  'Combustíveis e Lubrificantes': 'IVA 50% dedutível (art. 21.º CIVA)',
};

// ── P&L card (anual / trimestral) ───────────────────────────────────────────
function plCard(titulo, r, kmTotalKm){
  const resultClass=r.resultado>=0?'resultado-pos':'resultado-neg';
  const resultSign=r.resultado<0?'-':'';

  // ordenar categorias por valor desc
  const cats=Object.entries(r.por_categoria||{}).sort((a,b)=>b[1]-a[1]);

  let html=`<div class="card">
  <div class="card-head"><span>${titulo}</span></div>
  <div class="pl-section">

    <div class="pl-row section-title"><span>RENDIMENTOS</span></div>
    <div class="pl-row cat"><span>Prestações de serviços (cachets)</span><span>€${fmt(r.rendimentos)}</span></div>
    <div class="pl-row subtotal"><span>Total Rendimentos</span><span>€${fmt(r.rendimentos)}</span></div>

    <hr class="pl-sep">

    <div class="pl-row section-title" style="margin-top:14px"><span>GASTOS</span></div>
    <div class="pl-row cat" style="font-weight:600"><span>Fornecimentos e Serviços Externos (FSE)</span><span></span></div>`;

  for(const [cat,val] of cats){
    const isRep = REPRESENTACAO_CATS.has(cat);
    const ivaNote = IVA_FACTOR_LABEL[cat] ? ` <span class="cat-note">${IVA_FACTOR_LABEL[cat]}</span>` : '';
    const taNote  = isRep ? ` <span class="cat-ta">Trib. autónoma 10%</span>` : '';
    html+=`<div class="pl-row cat"><span>${cat||'Outros'}${ivaNote}${taNote}</span><span>€${fmt(val)}</span></div>`;
  }
  html+=`<div class="pl-row subtotal" style="padding-left:20px"><span>Subtotal FSE</span><span>€${fmt(r.gastos_despesas)}</span></div>`;

  if(r.gastos_km>0.005){
    const kmN=kmTotalKm>0?` (${fmt(kmTotalKm)} km × €0,40)`:'';
    html+=`<div class="pl-row cat"><span>Deslocações${kmN}</span><span>€${fmt(r.gastos_km)}</span></div>`;
  }
  html+=`<div class="pl-row subtotal"><span>Total Gastos</span><span>€${fmt(r.gastos_total)}</span></div>

    <hr class="pl-sep">
    <div class="pl-row ${resultClass}">
      <span>RESULTADO ANTES DE IRC</span>
      <span>${resultSign}€${fmt(Math.abs(r.resultado))}</span>
    </div>
  </div>
</div>`;
  return html;
}

// ── card IRC ─────────────────────────────────────────────────────────────────
function ircCard(r){
  const irc      = calcIRC(r.resultado);
  const ta       = r.tributacao_autonoma || 0;
  const taRep    = r.ta_representacao || 0;
  const taKm     = r.ta_km || 0;
  const taBase   = r.gastos_representacao || 0;
  const totalImp = Math.round((irc.total + ta)*100)/100;
  // PPC só sobre IRC+derrama (sem tributação autónoma — paga separadamente)
  const ppc      = Math.round(irc.total*0.80/3*100)/100;

  const semIRC = r.resultado <= 0;
  let html=`<div class="card irc-card"><div class="card-head">Estimativa IRC (PME)</div>
  <div class="pl-section">`;

  if(semIRC){
    html+=`<div class="irc-row"><span>Resultado negativo — sem IRC</span><span>€0,00</span></div>`;
  } else {
    const limiar  = CFG.irc_limiar_reduzida;
    const baseRed = Math.min(r.resultado, limiar);
    const baseNorm= Math.max(0, r.resultado - limiar);
    html+=`<div class="irc-row"><span>Base tributável</span><span>€${fmt(r.resultado)}</span></div>`;
    html+=`<div class="irc-row"><span>Primeiros €${fmt(limiar)} × ${CFG.irc_taxa_reduzida}%</span><span>€${fmt(baseRed*CFG.irc_taxa_reduzida/100)}</span></div>`;
    if(baseNorm>0)
      html+=`<div class="irc-row"><span>Restante × ${CFG.irc_taxa_normal}%</span><span>€${fmt(baseNorm*CFG.irc_taxa_normal/100)}</span></div>`;
    html+=`<div class="irc-row"><span>IRC estimado</span><span>€${fmt(irc.irc)}</span></div>`;
    html+=`<div class="irc-row"><span>Derrama municipal (${CFG.taxa_derrama}%)</span><span>€${fmt(irc.derrama)}</span></div>`;
    html+=`<div class="irc-row total"><span>IRC + Derrama</span><span>€${fmt(irc.total)}</span></div>`;
  }

  // tributação autónoma — aplica-se mesmo com resultado negativo
  if(ta > 0.005){
    html+=`<div class="irc-ta-block">
      <div class="irc-ta-title">Tributação Autónoma</div>`;
    if(taRep > 0.005){
      html+=`<div class="irc-row"><span>Desp. representação (base €${fmt(taBase)}) × 10% <span class="small">art. 88.º n.º 7</span></span><span>€${fmt(taRep)}</span></div>`;
    }
    if(taKm > 0.005){
      html+=`<div class="irc-row"><span>Compensações km (base €${fmt(r.gastos_km)}) × 5% <span class="small">art. 88.º n.º 9</span></span><span>€${fmt(taKm)}</span></div>`;
    }
    html+=`<div class="irc-row" style="font-weight:600;border-top:1px dashed #ccc;margin-top:4px;padding-top:4px"><span>Total trib. autónoma</span><span>€${fmt(ta)}</span></div>
      <div style="font-size:.74rem;color:#888;margin-top:4px">Aplica-se mesmo com resultado negativo</div>
    </div>`;
    html+=`<div class="irc-row total" style="margin-top:8px"><span>TOTAL IMPOSTOS</span><span>€${fmt(totalImp)}</span></div>`;
  }

  if(!semIRC && irc.total > 0){
    html+=`<div class="irc-ppc">
      <div class="irc-ppc-title">Pagamentos por Conta (estimativa)</div>
      <div style="font-size:.78rem;color:#888;margin-bottom:6px">Se IRC do ano anterior &gt; €1.000 (art.&nbsp;104 CIRC) — sobre IRC+Derrama</div>
      <div class="irc-ppc-row"><span>Julho</span><span>€${fmt(ppc)}</span></div>
      <div class="irc-ppc-row"><span>Setembro</span><span>€${fmt(ppc)}</span></div>
      <div class="irc-ppc-row"><span>Dezembro</span><span>€${fmt(ppc)}</span></div>
      <div class="irc-ppc-row" style="font-weight:700;border-top:1px solid #ddd;margin-top:4px;padding-top:6px">
        <span>Total PPC</span><span>€${fmt(ppc*3)}</span>
      </div>
    </div>`;
    html+=`<div style="font-size:.74rem;color:#aaa;margin-top:8px">
      Modelo 22 (declaração IRC anual): prazo 31 de Maio do ano seguinte
    </div>`;
  }
  html+=`</div></div>`;
  return html;
}

// ── km total para label ───────────────────────────────────────────────────────
function kmTotal(rows){
  return rows.reduce((s,r)=>{
    // km_€ = km × 0.40, reconstruir km se possível
    return s + (r.gastos_km/0.40);
  },0);
}

// ── vistas ───────────────────────────────────────────────────────────────────
function renderAnual(ano){
  const rows=DADOS.filter(d=>d.year===ano);
  if(!rows.length) return `<div class="empty-state">Sem dados para ${ano}.<br>Sincronize o calendário e as despesas.</div>`;
  const r=agregar(rows);
  return `<div class="layout">
    <div>${plCard('Conta Corrente '+ano, r, Math.round(kmTotal(rows)))}</div>
    <div>${ircCard(r)}</div>
  </div>`;
}

function renderTrimestral(ano){
  let html='';
  for(const qt of TRIMESTRES){
    const rows=qt.meses.map(m=>dadosMes(ano,m)).filter(Boolean);
    if(!rows.length) continue;
    const r=agregar(rows);
    html+=`<div class="layout">
      <div>${plCard(`${qt.label} ${ano} (${MESES[qt.meses[0]-1].substring(0,3)}–${MESES[qt.meses[2]-1].substring(0,3)})`, r, Math.round(kmTotal(rows)))}</div>
      <div>${ircCard(r)}</div>
    </div>`;
  }
  return html||`<div class="empty-state">Sem dados para ${ano}.</div>`;
}

function renderMensal(ano){
  const rows=DADOS.filter(d=>d.year===ano).sort((a,b)=>a.month-b.month);
  if(!rows.length) return `<div class="empty-state">Sem dados para ${ano}.</div>`;
  let html=`<div class="card"><table><thead><tr>
    <th>Mês</th><th class="num">Rendimentos</th><th class="num">Gastos FSE</th>
    <th class="num">Gastos KM</th><th class="num">Total Gastos</th>
    <th class="num">Resultado</th><th class="num">IRC+Derrama</th>
    <th class="num">Trib. Autónoma</th><th class="num">Total Impostos</th>
  </tr></thead><tbody>`;
  let tot={rendimentos:0,gastos_despesas:0,gastos_km:0,gastos_total:0,resultado:0,tributacao_autonoma:0};
  for(const r of rows){
    const irc=calcIRC(r.resultado);
    const ta=r.tributacao_autonoma||0;
    const cls=r.resultado>=0?'pos':'neg';
    html+=`<tr>
      <td>${MESES[r.month-1]}</td>
      <td class="num">€${fmt(r.rendimentos)}</td>
      <td class="num">€${fmt(r.gastos_despesas)}</td>
      <td class="num">€${fmt(r.gastos_km)}</td>
      <td class="num">€${fmt(r.gastos_total)}</td>
      <td class="num ${cls}">€${fmt(Math.abs(r.resultado))}${r.resultado<0?' (prej.)':''}</td>
      <td class="num">€${fmt(irc.total)}</td>
      <td class="num">${ta>0.005?'€'+fmt(ta):'—'}</td>
      <td class="num">€${fmt(Math.round((irc.total+ta)*100)/100)}</td>
    </tr>`;
    ['rendimentos','gastos_despesas','gastos_km','gastos_total','resultado','tributacao_autonoma'].forEach(k=>tot[k]+=(r[k]||0));
  }
  const totIRC=calcIRC(tot.resultado);
  const tcls=tot.resultado>=0?'pos':'neg';
  const totTA=Math.round(tot.tributacao_autonoma*100)/100;
  html+=`<tr style="font-weight:700;background:#f8faff">
    <td>Total</td>
    <td class="num">€${fmt(tot.rendimentos)}</td>
    <td class="num">€${fmt(tot.gastos_despesas)}</td>
    <td class="num">€${fmt(tot.gastos_km)}</td>
    <td class="num">€${fmt(tot.gastos_total)}</td>
    <td class="num ${tcls}">€${fmt(Math.abs(tot.resultado))}</td>
    <td class="num">€${fmt(totIRC.total)}</td>
    <td class="num">${totTA>0.005?'€'+fmt(totTA):'—'}</td>
    <td class="num">€${fmt(Math.round((totIRC.total+totTA)*100)/100)}</td>
  </tr></tbody></table></div>`;
  return html;
}

function setView(v){
  currentView=v;
  ['Mensal','Trimestral','Anual'].forEach(n=>{
    document.getElementById('btn'+n).classList.toggle('active',n.toLowerCase()===v);
  });
  render();
}

function render(){
  const ano=selectedAno();
  const cont=document.getElementById('mainContainer');
  if(currentView==='mensal')      cont.innerHTML=renderMensal(ano);
  else if(currentView==='trimestral') cont.innerHTML=renderTrimestral(ano);
  else                             cont.innerHTML=renderAnual(ano);
}

// ── CSV ──────────────────────────────────────────────────────────────────────
function exportarCSV(){
  const ano=selectedAno();
  const rows=DADOS.filter(d=>d.year===ano).sort((a,b)=>a.month-b.month);
  let csv=bom('Mês;Rendimentos;Gastos FSE;Gastos KM;Total Gastos;Resultado;IRC;Derrama;Trib. Autónoma;Total Impostos\n');
  let tot={rendimentos:0,gastos_despesas:0,gastos_km:0,gastos_total:0,resultado:0,tributacao_autonoma:0};
  for(const r of rows){
    const irc=calcIRC(r.resultado);
    const ta=r.tributacao_autonoma||0;
    csv+=`${MESES[r.month-1]};${eur(r.rendimentos)};${eur(r.gastos_despesas)};${eur(r.gastos_km)};${eur(r.gastos_total)};${eur(r.resultado)};${eur(irc.irc)};${eur(irc.derrama)};${eur(ta)};${eur(Math.round((irc.total+ta)*100)/100)}\n`;
    ['rendimentos','gastos_despesas','gastos_km','gastos_total','resultado','tributacao_autonoma'].forEach(k=>tot[k]+=(r[k]||0));
  }
  const totIRC=calcIRC(tot.resultado);
  const totTA=Math.round(tot.tributacao_autonoma*100)/100;
  csv+=`TOTAL;${eur(tot.rendimentos)};${eur(tot.gastos_despesas)};${eur(tot.gastos_km)};${eur(tot.gastos_total)};${eur(tot.resultado)};${eur(totIRC.irc)};${eur(totIRC.derrama)};${eur(totTA)};${eur(Math.round((totIRC.total+totTA)*100)/100)}\n`;
  fetch('/api/export_csv',{method:'POST',headers:{'Content-Type':'application/json'},
    body:JSON.stringify({filename:`conta_corrente_${ano}.csv`,content:csv})})
  .then(r=>r.json()).then(d=>{
    if(d.ok) alert('Ficheiro guardado em:\n'+d.path);
    else alert('Erro: '+d.error);
  });
}

// ── configuração ─────────────────────────────────────────────────────────────
function openCfg(){
  document.getElementById('cfgIvaRend').value  = CFG.taxa_iva_rendimentos;
  document.getElementById('cfgIrcRed').value   = CFG.irc_taxa_reduzida;
  document.getElementById('cfgIrcLimiar').value= CFG.irc_limiar_reduzida;
  document.getElementById('cfgIrcNorm').value  = CFG.irc_taxa_normal;
  document.getElementById('cfgDerrama').value  = CFG.taxa_derrama;
  document.getElementById('cfgSaPath').value   = CFG.service_account_path;
  document.getElementById('cfgModal').classList.add('show');
}
function closeCfg(){ document.getElementById('cfgModal').classList.remove('show'); }
function closeCfgOutside(e){ if(e.target===document.getElementById('cfgModal')) closeCfg(); }

function saveCfg(){
  const body={
    taxa_iva_rendimentos: parseFloat(document.getElementById('cfgIvaRend').value),
    irc_taxa_reduzida:    parseFloat(document.getElementById('cfgIrcRed').value),
    irc_limiar_reduzida:  parseFloat(document.getElementById('cfgIrcLimiar').value),
    irc_taxa_normal:      parseFloat(document.getElementById('cfgIrcNorm').value),
    taxa_derrama:         parseFloat(document.getElementById('cfgDerrama').value),
    service_account_path: document.getElementById('cfgSaPath').value.trim(),
  };
  fetch('/api/contab_config',{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)})
  .then(r=>r.json()).then(d=>{
    if(d.ok){ Object.assign(CFG,body); closeCfg(); render(); }
    else alert('Erro ao guardar: '+d.error);
  });
}

// ── init ─────────────────────────────────────────────────────────────────────
(function(){
  const sel=document.getElementById('anoSel');
  const cur=new Date().getFullYear();
  anos().forEach(a=>{
    const o=document.createElement('option');
    o.value=a; o.textContent=a;
    if(a===cur) o.selected=true;
    sel.appendChild(o);
  });
  render();
})();
</script>
</body>
</html>
