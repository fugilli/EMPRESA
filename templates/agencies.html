<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <title>AgÃªncias â€“ GestÃ£o de Empresa</title>
  <script>(function(){var t=localStorage.getItem('theme');if(t==='dark'||(!t&&window.matchMedia('(prefers-color-scheme: dark)').matches))document.documentElement.classList.add('dark');})()</script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background: #f0f2f5; font-family: system-ui, sans-serif; margin: 0; }

    .topbar { background:#1a1a2e; color:#fff; padding:0 24px; display:flex; align-items:center; justify-content:space-between; height:52px; }
    .brand { font-weight:600; font-size:1rem; }
    .topbar-right { display:flex; align-items:center; gap:12px; }
    .badge-cal { background:#4f8ef7; color:#fff; border-radius:20px; padding:3px 12px; font-size:.8rem; }
    .btn-topbar { color:#fff; font-size:.78rem; border:1px solid rgba(255,255,255,.4); border-radius:5px; padding:4px 10px; text-decoration:none; cursor:pointer; background:none; }
    .btn-topbar:hover { background:rgba(255,255,255,.1); color:#fff; }
    .tabs { background:#fff; border-bottom:2px solid #e5e7eb; display:flex; padding:0 24px; }
    .tab { padding:12px 20px; font-size:.9rem; font-weight:500; color:#666; text-decoration:none; border-bottom:3px solid transparent; margin-bottom:-2px; transition:color .15s; }
    .tab:hover { color:#1a1a2e; }
    .tab.active { color:#1a1a2e; border-bottom-color:#4f8ef7; }

    .main { padding: 20px 24px; }

    .toolbar { display: flex; align-items: center; gap: 12px; margin-bottom: 20px; }
    .toolbar h2 { margin: 0; font-size: 1.1rem; font-weight: 600; flex: 1; }

    .new-agency-form { background: #fff; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,.07); padding: 18px 20px; margin-bottom: 20px; display: none; }
    .new-agency-form.visible { display: block; }
    .form-row { display: flex; gap: 10px; flex-wrap: wrap; align-items: flex-end; }
    .form-group { display: flex; flex-direction: column; gap: 4px; }
    .form-group label { font-size: .75rem; font-weight: 700; color: #888; text-transform: uppercase; letter-spacing: .4px; }
    .form-group input { border: 1px solid #ddd; border-radius: 6px; padding: 7px 10px; font-size: .9rem; outline: none; }
    .form-group input:focus { border-color: #4f8ef7; box-shadow: 0 0 0 2px rgba(79,142,247,.15); }

    /* cards */
    .agency-card { background: #fff; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,.07); margin-bottom: 14px; }
    .agency-header { display: flex; align-items: center; padding: 14px 18px; gap: 10px; border-bottom: 1px solid #f0f0f0; }
    .agency-fields { flex: 1; display: flex; gap: 20px; flex-wrap: wrap; align-items: center; }
    .field-group { display: flex; flex-direction: column; gap: 2px; }
    .field-label { font-size: .68rem; font-weight: 700; color: #bbb; text-transform: uppercase; letter-spacing: .5px; }
    .agency-input { border: 1px solid transparent; border-radius: 5px; padding: 3px 7px; font-size: .95rem; font-weight: 600; outline: none; background: transparent; color: #1a1a2e; }
    .agency-input.nif-f { font-weight: 400; font-size: .88rem; color: #555; max-width: 140px; }
    .agency-input:hover { border-color: #ddd; background: #f8f8f8; }
    .agency-input:focus { border-color: #4f8ef7; background: #fff; }

    .btn-del-agency { background: none; border: none; color: #ddd; font-size: 1rem; cursor: pointer; padding: 5px 7px; border-radius: 5px; }
    .btn-del-agency:hover { color: #e53935; background: #fff0f0; }

    /* artistas */
    .artists-section { padding: 14px 18px; }
    .artists-title { font-size: .72rem; font-weight: 700; color: #bbb; text-transform: uppercase; letter-spacing: .5px; margin-bottom: 12px; }

    .artist-row { display: flex; align-items: center; gap: 10px; padding: 7px 0; border-bottom: 1px solid #f5f5f5; }
    .artist-row:last-of-type { border-bottom: none; }
    .artist-name { flex: 1; font-size: .9rem; font-weight: 500; color: #222; }

    .cachet-group { display: flex; align-items: center; gap: 6px; }
    .cachet-label { font-size: .72rem; color: #aaa; white-space: nowrap; }
    .cachet-base-input { border: 1px solid #e0e0e0; border-radius: 6px; padding: 4px 8px; font-size: .85rem; width: 90px; outline: none; text-align: right; }
    .cachet-base-input:focus { border-color: #4f8ef7; box-shadow: 0 0 0 2px rgba(79,142,247,.15); }

    .btn-refresh { background: #e8f5e9; color: #2e7d32; border: none; border-radius: 6px; padding: 4px 10px; font-size: .75rem; font-weight: 600; cursor: pointer; white-space: nowrap; }
    .btn-refresh:hover { background: #c8e6c9; }
    .btn-refresh:disabled { opacity: .5; cursor: default; }

    .btn-remove-artist { background: none; border: none; color: #ddd; font-size: .9rem; cursor: pointer; padding: 3px 5px; border-radius: 4px; }
    .btn-remove-artist:hover { color: #e53935; background: #fff0f0; }

    /* add artist row */
    .add-artist-row { display: flex; gap: 8px; align-items: center; margin-top: 12px; padding-top: 10px; border-top: 1px dashed #eee; }
    .add-artist-input { border: 1px solid #ddd; border-radius: 6px; padding: 6px 10px; font-size: .85rem; outline: none; flex: 1; max-width: 240px; }
    .add-artist-input:focus { border-color: #4f8ef7; }
    .add-cachet-input { border: 1px solid #ddd; border-radius: 6px; padding: 6px 8px; font-size: .85rem; outline: none; width: 90px; text-align: right; }
    .add-cachet-input:focus { border-color: #4f8ef7; }

    .btn-add { background: #4f8ef7; color: #fff; border: none; border-radius: 6px; padding: 6px 14px; font-size: .82rem; cursor: pointer; font-weight: 500; }
    .btn-add:hover { background: #3a7ae0; }
    .btn-outline { background: #fff; color: #4f8ef7; border: 1px solid #4f8ef7; border-radius: 6px; padding: 7px 16px; font-size: .85rem; cursor: pointer; font-weight: 500; }
    .btn-outline:hover { background: #f0f4ff; }

    .empty-state { color: #ccc; font-size: .9rem; padding: 48px; text-align: center; }
    .toast { position: fixed; bottom: 24px; right: 24px; background: #1a1a2e; color: #fff; padding: 10px 18px; border-radius: 8px; font-size: .85rem; opacity: 0; transition: opacity .3s; pointer-events: none; z-index: 999; }
    .toast.show { opacity: 1; }

    /* â”€â”€ dark mode â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    html.dark body { background:#111318; color:#e0e6f0; }
    html.dark .tabs { background:#161921; border-bottom-color:#2a2d3e; }
    html.dark .tab { color:#8b9ab0; }
    html.dark .tab:hover { color:#e0e6f0; }
    html.dark .tab.active { color:#e0e6f0; }
    html.dark .toolbar h2 { color:#e0e6f0; }
    html.dark .new-agency-form { background:#1e2130; box-shadow:0 2px 8px rgba(0,0,0,.4); }
    html.dark .form-group label { color:#8b9ab0; }
    html.dark .form-group input { background:#252838; border-color:#3a3d4e; color:#e0e6f0; }
    html.dark .agency-card { background:#1e2130; box-shadow:0 2px 8px rgba(0,0,0,.4); }
    html.dark .agency-header { border-bottom-color:#252838; }
    html.dark .field-label { color:#5a6478; }
    html.dark .agency-input { color:#e0e6f0; }
    html.dark .agency-input:hover { border-color:#3a3d4e; background:#252838; }
    html.dark .agency-input:focus { background:#252838; }
    html.dark .agency-input.nif-f { color:#8b9ab0; }
    html.dark .btn-del-agency:hover { background:#2a1515; }
    html.dark .artists-section { border-top-color:#252838; }
    html.dark .artists-title { color:#5a6478; }
    html.dark .artist-row { border-bottom-color:#252838; }
    html.dark .artist-name { color:#e0e6f0; }
    html.dark .cachet-label { color:#5a6478; }
    html.dark .cachet-base-input { background:#252838; border-color:#3a3d4e; color:#e0e6f0; }
    html.dark .add-artist-row { border-top-color:#2a2d3e; }
    html.dark .add-artist-input { background:#252838; border-color:#3a3d4e; color:#e0e6f0; }
    html.dark .add-cachet-input { background:#252838; border-color:#3a3d4e; color:#e0e6f0; }
    html.dark .btn-outline { background:#1e2130; color:#4f8ef7; border-color:#4f8ef7; }
    html.dark .btn-outline:hover { background:#1a2040; }
    html.dark .empty-state { color:#5a6478; }
  </style>
</head>
<body>
{% set active_tab = 'agencias' %}
{% include '_nav.html' %}

<div class="main">
  <div class="toolbar">
    <h2>AgÃªncias</h2>
    <button class="btn-outline" onclick="toggleNewForm()">+ Nova AgÃªncia</button>
  </div>

  <div class="new-agency-form" id="newAgencyForm">
    <div class="form-row">
      <div class="form-group">
        <label>Nome da AgÃªncia</label>
        <input type="text" id="newNome" placeholder="Nome da agÃªncia" style="min-width:200px"
               onkeydown="if(event.key==='Enter') createAgency()">
      </div>
      <div class="form-group">
        <label>NIF</label>
        <input type="text" id="newNif" placeholder="000000000" style="max-width:140px"
               onkeydown="if(event.key==='Enter') createAgency()">
      </div>
      <div style="display:flex;gap:8px;align-self:flex-end">
        <button class="btn-add" onclick="createAgency()">Criar</button>
        <button class="btn-outline" style="color:#888;border-color:#ccc" onclick="toggleNewForm()">Cancelar</button>
      </div>
    </div>
  </div>

  <div id="agenciesList"></div>
</div>

<div class="toast" id="toast"></div>

<!-- datalist preenchido dinamicamente com artistas do calendÃ¡rio -->
<datalist id="artists-datalist"></datalist>

<script>
  let agencies  = [];
  let calArtists = [];

  // â”€â”€ init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function init() {
    // carregar artistas do calendÃ¡rio e agÃªncias em paralelo
    const [agRes, artRes] = await Promise.all([
      fetch('/api/agencias'),
      fetch('/api/artistas')
    ]);
    agencies   = await agRes.json();
    calArtists = await artRes.json();

    // preencher datalist
    const dl = document.getElementById('artists-datalist');
    dl.innerHTML = calArtists.map(a => `<option value="${escHtml(a)}">`).join('');

    render();
  }

  // â”€â”€ render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function render() {
    const c = document.getElementById('agenciesList');
    if (!agencies.length) {
      c.innerHTML = '<div class="empty-state">Nenhuma agÃªncia criada.<br>Clica em "+ Nova AgÃªncia" para comeÃ§ar.</div>';
      return;
    }
    c.innerHTML = agencies.map(agencyCard).join('');
    bindEvents();
  }

  function agencyCard(ag) {
    const rows = ag.artistas.map(a => `
      <div class="artist-row" id="arow_${ag.id}_${escId(a.nome)}">
        <span class="artist-name">${escHtml(a.nome)}</span>
        <div class="cachet-group">
          <span class="cachet-label">Cachet base â‚¬</span>
          <input class="cachet-base-input" type="number" step="0.01" min="0"
                 id="cb_${ag.id}_${escId(a.nome)}"
                 value="${escHtml(a.cachet_base)}" placeholder="0"
                 data-agency="${ag.id}" data-nome="${escHtml(a.nome)}">
          <button class="btn-refresh" id="rbtn_${ag.id}_${escId(a.nome)}"
                  onclick="refreshArtist('${ag.id}','${escJs(a.nome)}')"
                  title="Aplicar este cachet base a todos os concertos futuros deste artista">
            â†» Actualizar datas futuras
          </button>
        </div>
        <button class="btn-remove-artist" onclick="removeArtist('${ag.id}','${escJs(a.nome)}')" title="Remover artista">Ã—</button>
      </div>`).join('') || '<p style="color:#ccc;font-size:.82rem;margin:0 0 8px">Nenhum artista associado</p>';

    return `
    <div class="agency-card">
      <div class="agency-header">
        <div class="agency-fields">
          <div class="field-group">
            <span class="field-label">AgÃªncia</span>
            <input class="agency-input" id="nome_${ag.id}" value="${escHtml(ag.nome)}" data-agency="${ag.id}" data-field="nome">
          </div>
          <div class="field-group">
            <span class="field-label">NIF</span>
            <input class="agency-input nif-f" id="nif_${ag.id}" value="${escHtml(ag.nif)}" data-agency="${ag.id}" data-field="nif">
          </div>
        </div>
        <button class="btn-del-agency" onclick="deleteAgency('${ag.id}')" title="Eliminar agÃªncia">ðŸ—‘</button>
      </div>
      <div class="artists-section">
        <div class="artists-title">Artistas</div>
        ${rows}
        <div class="add-artist-row">
          <input class="add-artist-input" id="addName_${ag.id}" list="artists-datalist"
                 placeholder="Nome do artistaâ€¦" autocomplete="off">
          <input class="add-cachet-input" id="addCachet_${ag.id}" type="number" step="0.01" min="0" placeholder="Cachet â‚¬">
          <button class="btn-add" onclick="addArtist('${ag.id}')">+ Adicionar</button>
        </div>
      </div>
    </div>`;
  }

  function bindEvents() {
    // guardar nome/nif agÃªncia ao sair do campo
    document.querySelectorAll('.agency-input').forEach(inp => {
      let orig = inp.value;
      inp.addEventListener('focus', () => { orig = inp.value; });
      inp.addEventListener('blur', () => {
        if (inp.value === orig) return;
        const body = {}; body[inp.dataset.field] = inp.value;
        fetch(`/api/agencias/${inp.dataset.agency}`, {
          method:'PUT', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body)
        });
        orig = inp.value;
      });
      inp.addEventListener('keydown', e => { if(e.key==='Enter') inp.blur(); });
    });

    // guardar cachet_base ao sair do campo
    document.querySelectorAll('.cachet-base-input').forEach(inp => {
      let orig = inp.value;
      inp.addEventListener('focus', () => { orig = inp.value; });
      inp.addEventListener('blur', () => {
        if (inp.value === orig) return;
        fetch(`/api/agencias/${inp.dataset.agency}/artistas/cachet`, {
          method:'PUT', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({nome: inp.dataset.nome, cachet_base: inp.value})
        });
        orig = inp.value;
      });
      inp.addEventListener('keydown', e => { if(e.key==='Enter') inp.blur(); });
    });

    // enter no campo de nome do artista â†’ adicionar
    document.querySelectorAll('.add-artist-input').forEach(inp => {
      inp.addEventListener('keydown', e => {
        if (e.key === 'Enter') {
          const agId = inp.id.replace('addName_','');
          addArtist(agId);
        }
      });
    });
  }

  // â”€â”€ actions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function toggleNewForm() {
    const f = document.getElementById('newAgencyForm');
    f.classList.toggle('visible');
    if (f.classList.contains('visible')) document.getElementById('newNome').focus();
  }

  async function createAgency() {
    const nome = document.getElementById('newNome').value.trim();
    const nif  = document.getElementById('newNif').value.trim();
    if (!nome) { document.getElementById('newNome').focus(); return; }
    const res  = await fetch('/api/agencias', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({nome, nif})
    });
    if ((await res.json()).ok) {
      document.getElementById('newNome').value = '';
      document.getElementById('newNif').value  = '';
      document.getElementById('newAgencyForm').classList.remove('visible');
      await reload();
    }
  }

  async function deleteAgency(id) {
    if (!confirm('Tens a certeza que queres eliminar esta agÃªncia?')) return;
    await fetch(`/api/agencias/${id}`, {method:'DELETE'});
    await reload();
  }

  async function addArtist(agId) {
    const nome   = document.getElementById(`addName_${agId}`).value.trim();
    const cachet = document.getElementById(`addCachet_${agId}`).value.trim();
    if (!nome) { document.getElementById(`addName_${agId}`).focus(); return; }
    const res = await fetch(`/api/agencias/${agId}/artistas`, {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({nome, cachet_base: cachet})
    });
    if ((await res.json()).ok) {
      document.getElementById(`addName_${agId}`).value   = '';
      document.getElementById(`addCachet_${agId}`).value = '';
      await reload();
    }
  }

  async function removeArtist(agId, nome) {
    await fetch(`/api/agencias/${agId}/artistas`, {
      method:'DELETE', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({nome})
    });
    await reload();
  }

  async function refreshArtist(agId, nome) {
    const cachetInput = document.getElementById(`cb_${agId}_${escId(nome)}`);
    const cachet_base = cachetInput ? cachetInput.value.trim() : '';
    if (!cachet_base) {
      showToast('Define primeiro o cachet base antes de actualizar.');
      return;
    }
    const btn = document.getElementById(`rbtn_${agId}_${escId(nome)}`);
    btn.disabled = true;
    btn.textContent = 'â†» A actualizarâ€¦';

    const res  = await fetch(`/api/agencias/${agId}/artistas/refresh`, {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({nome, cachet_base})
    });
    const data = await res.json();
    btn.disabled = false;
    btn.textContent = 'â†» Actualizar datas futuras';

    if (data.ok) {
      showToast(`${data.updated} concerto(s) actualizados a partir de hoje.`);
    } else {
      showToast('Erro: ' + (data.error || 'desconhecido'));
    }
  }

  async function reload() {
    const [agRes, artRes] = await Promise.all([
      fetch('/api/agencias'),
      fetch('/api/artistas')
    ]);
    agencies   = await agRes.json();
    calArtists = await artRes.json();
    const dl   = document.getElementById('artists-datalist');
    dl.innerHTML = calArtists.map(a => `<option value="${escHtml(a)}">`).join('');
    render();
  }

  function showToast(msg) {
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.classList.add('show');
    setTimeout(() => t.classList.remove('show'), 3000);
  }

  // â”€â”€ utils â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function escHtml(s) {
    return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
  }
  function escJs(s) {
    return String(s||'').replace(/\\/g,'\\\\').replace(/'/g,"\\'");
  }
  function escId(s) {
    // gerar um ID CSS-safe a partir do nome do artista
    return String(s||'').replace(/[^a-zA-Z0-9]/g,'_');
  }

  init();
</script>
</body>
</html>
